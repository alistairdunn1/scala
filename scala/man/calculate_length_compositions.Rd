% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_length_compositions.R
\name{calculate_length_compositions}
\alias{calculate_length_compositions}
\title{Calculate Length Compositions with Optional Bootstrap Uncertainty (Sex-Based)}
\usage{
calculate_length_compositions(
  fish_data,
  strata_data,
  length_range = c(min(fish_data$length), max(fish_data$length)),
  lw_params_male,
  lw_params_female,
  lw_params_unsexed,
  bootstraps = 0,
  plus_group = FALSE,
  minus_group = FALSE,
  return_full_bootstraps = FALSE,
  verbose = TRUE
)
}
\arguments{
\item{fish_data}{Data frame with columns: stratum, sample_id, length, male, female, unsexed, sample_weight_kg, total_catch_weight_kg (weight-based) OR stratum, sample_id, length, male, female, unsexed, sample_area_km2, catch_density_kg_km2 (density-based)}

\item{strata_data}{Data frame with columns: stratum, stratum_total_catch_kg (weight-based) OR stratum, stratum_area_km2 (density-based)}

\item{length_range}{Numeric vector of min and max lengths to include (e.g., c(15, 35))}

\item{lw_params_male}{Named vector with length-weight parameters for males: c(a = 0.01, b = 3.0)}

\item{lw_params_female}{Named vector with length-weight parameters for females: c(a = 0.01, b = 3.0)}

\item{lw_params_unsexed}{Named vector with length-weight parameters for unsexed fish: c(a = 0.01, b = 3.0)}

\item{bootstraps}{Integer, number of bootstrap iterations. Set to 0 for no bootstrapping (default 300)}

\item{plus_group}{Logical, combine lengths >= max length into a plus group (default FALSE)}

\item{minus_group}{Logical, combine lengths <= min length into a minus group (default FALSE)}

\item{return_full_bootstraps}{Logical, whether to return all individual bootstrap results along with summaries (default FALSE)}

\item{verbose}{Logical, whether to print progress messages (default TRUE)}
}
\value{
When bootstraps > 0: List containing:
  \itemize{
    \item length_composition: 3D array (length x sex x stratum) of scaled length compositions
    \item proportions: 3D array (length x sex x stratum) of proportions
    \item pooled_length_composition: matrix (length x sex) of pooled compositions
    \item pooled_proportions: matrix (length x sex) of pooled proportions
    \item lc_cvs: 3D array of CVs for length compositions
    \item proportions_cvs: 3D array of CVs for proportions
    \item pooled_lc_cv: matrix of pooled CVs
    \item pooled_proportions_cv: matrix of pooled proportion CVs
    \item lc_ci_lower: 3D array of 2.5th percentile values for length compositions
    \item lc_ci_upper: 3D array of 97.5th percentile values for length compositions
    \item pooled_lc_ci_lower: matrix of 2.5th percentile values for pooled compositions
    \item pooled_lc_ci_upper: matrix of 97.5th percentile values for pooled compositions
    \item proportions_ci_lower: 3D array of 2.5th percentile values for proportions
    \item proportions_ci_upper: 3D array of 97.5th percentile values for proportions
    \item pooled_proportions_ci_lower: matrix of 2.5th percentile values for pooled proportions
    \item pooled_proportions_ci_upper: matrix of 97.5th percentile values for pooled proportions
    \item lc_bootstraps: 4D array of bootstrap results (length x sex x stratum x bootstrap)
    \item full_lc_bootstraps: 4D array of all individual bootstrap length compositions (only when return_full_bootstraps = TRUE)
    \item full_pooled_lc_bootstraps: 3D array of all individual pooled bootstrap compositions (only when return_full_bootstraps = TRUE)
    \item full_prop_bootstraps: 4D array of all individual bootstrap proportions (only when return_full_bootstraps = TRUE)
    \item full_pooled_prop_bootstraps: 3D array of all individual pooled bootstrap proportions (only when return_full_bootstraps = TRUE)
    \item lengths: vector of length bins
    \item strata_names: vector of stratum names
    \item n_bootstraps: number of bootstrap iterations
    \item plus_group: logical, plus group used
    \item minus_group: logical, minus group used
    \item has_sex_data: logical, TRUE if sex-based columns present
    \item scaling_type: character, type of scaling used ("weight" or "density")
    \item summary_stats: list containing pre-computed summary statistics with components:
      \itemize{
        \item total_summary: list with n_fish (named vector of fish counts by sex) and n_hauls (total number of hauls)
        \item stratum_summary: named list by stratum, each containing n_fish and n_hauls for that stratum
      }
  }
  When bootstraps = 0: List containing:
  \itemize{
    \item \code{length_compositions}: 3D array (length x sex x stratum) of scaled length compositions
    \item \code{lengths}: Vector of length bin centers
    \item \code{strata_names}: Vector of stratum names
    \item \code{n_bootstraps}: 0 (no bootstraps performed)
    \item \code{plus_group}: Plus group setting
    \item \code{minus_group}: Minus group setting
    \item \code{has_sex_data}: TRUE (indicates sex-specific analysis)
    \item \code{scaling_type}: Type of scaling applied
  }
}
\description{
Calculates length compositions for fish data by sex and stratum, applying upweighting and optionally bootstrap resampling to estimate uncertainty.
Supports both weight-based scaling (commercial fisheries) and density-based scaling (surveys).
}
\details{
The function applies a two-stage upweighting process and uses bootstrap resampling to estimate uncertainty in length composition and proportion estimates.

**Weight-based scaling (commercial fisheries):**
- Sample scaling: total_catch_weight_kg / observed_sample_weight
- Stratum scaling: stratum_total_catch_kg / sum_of_sample_catches_in_stratum

**Density-based scaling (surveys):**
- Sample scaling: catch_density_kg_km2 * sample_area_km2 / observed_sample_weight
- Stratum scaling: stratum_area_km2 / sum_of_sample_areas_in_stratum

**Length-weight relationships:**
Uses the allometric relationship: Weight = a * Length^b
where a and b are species and sex-specific parameters.

**Bootstrap uncertainty estimation:**
When bootstraps > 0, the function provides multiple uncertainty measures using a hierarchical resampling approach:
- **Sample-level resampling**: Samples are resampled with replacement within each stratum to capture spatial/temporal variation
- **Fish-level resampling**: Individual fish are resampled with replacement within each sample to capture within-sample variation
- **Coefficient of Variation (CV)**: Relative variability as standard deviation / mean across bootstrap iterations
- **Empirical 95 percent confidence intervals**: 2.5th and 97.5th percentiles of bootstrap distribution

This hierarchical approach captures both between-sample and within-sample uncertainty, providing more comprehensive
and realistic uncertainty estimates than single-level resampling. The confidence intervals are non-parametric
and do not assume any distributional form.

**Data validation:**
The function validates that all strata present in fish_data are also present in strata_data.
This ensures that stratum-level scaling factors can be calculated for all fish observations.
If strata exist in strata_data but not in fish_data, a warning is issued to alert users
of potentially unused stratum information.

Sex categories are: male, female, unsexed, and total. Plus and minus group functionality is available for aggregating extreme length bins.
}
\examples{
\dontrun{
# Length-weight parameters (example for snapper)
lw_male <- c(a = 0.0085, b = 3.1)
lw_female <- c(a = 0.0092, b = 3.05)
lw_unsexed <- c(a = 0.0088, b = 3.08)

# Weight-based example (commercial fisheries)
fish_data <- data.frame(
  stratum = c("A", "A", "B", "B"),
  sample_id = c(1, 1, 2, 2),
  length = c(20, 25, 22, 28),
  male = c(2, 1, 3, 2),
  female = c(2, 1, 2, 1),
  unsexed = c(1, 1, 2, 1),
  sample_weight_kg = c(10, 10, 15, 15),
  total_catch_weight_kg = c(100, 100, 150, 150)
)
strata_data <- data.frame(
  stratum = c("A", "B"),
  stratum_total_catch_kg = c(1000, 2000)
)

results <- calculate_length_compositions(
  fish_data = fish_data,
  strata_data = strata_data,
  length_range = c(15, 35),
  lw_params_male = lw_male,
  lw_params_female = lw_female,
  lw_params_unsexed = lw_unsexed,
  bootstraps = 100
)
print(results)

# For age composition analysis, get full bootstrap results
results_full <- calculate_length_compositions(
  fish_data = fish_data,
  strata_data = strata_data,
  length_range = c(15, 35),
  lw_params_male = lw_male,
  lw_params_female = lw_female,
  lw_params_unsexed = lw_unsexed,
  bootstraps = 100,
  return_full_bootstraps = TRUE
)
# Access individual bootstrap iteration results
bootstrap_1 <- results_full$full_lc_bootstraps[, , , 1]
}

}
\seealso{
\code{\link{plot.length_composition}} for plotting results,
\code{\link{print.length_composition}} for printing summaries,
\code{\link{get_default_lw_params}} for default length-weight parameters,
\code{\link{generate_test_data}} for creating test datasets
}
