% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_age_compositions_from_cohort.R
\name{calculate_age_compositions_from_cohort}
\alias{calculate_age_compositions_from_cohort}
\title{Calculate Age Compositions from Cohort Model Predictions}
\usage{
calculate_age_compositions_from_cohort(
  fish_data,
  strata_data,
  age_range,
  lw_params_male,
  lw_params_female,
  lw_params_unsexed,
  bootstraps = 300,
  plus_group_age = TRUE,
  minus_group_age = FALSE,
  verbose = TRUE
)
}
\arguments{
\item{fish_data}{Data frame with age-assigned fish data. Must contain columns:
- age, length, year, sex, stratum, sample_id
- male, female, unsexed (fish counts by sex)
- For weight-based: sample_weight_kg, total_catch_weight_kg
- For density-based: sample_area_km2, catch_density_kg_km2}

\item{strata_data}{Data frame with stratum-level information:
- For weight-based: stratum, stratum_total_catch_kg
- For density-based: stratum, stratum_area_km2}

\item{age_range}{Numeric vector of min and max ages to include (e.g., c(1, 10))}

\item{lw_params_male}{Named vector with length-weight parameters for males: c(a = 0.01, b = 3.0)}

\item{lw_params_female}{Named vector with length-weight parameters for females: c(a = 0.01, b = 3.0)}

\item{lw_params_unsexed}{Named vector with length-weight parameters for unsexed fish: c(a = 0.01, b = 3.0)}

\item{bootstraps}{Integer, number of bootstrap iterations. Set to 0 for no bootstrapping (default 300)}

\item{plus_group_age}{Logical, combine ages >= max age into a plus group (default TRUE)}

\item{minus_group_age}{Logical, combine ages <= min age into a minus group (default FALSE)}

\item{verbose}{Logical, whether to print progress messages (default TRUE)}
}
\value{
List containing:
  \itemize{
    \item \code{age_composition}: 3D array (age x sex x stratum) of scaled age compositions
    \item \code{age_proportions}: 3D array (age x sex x stratum) of age proportions
    \item \code{pooled_age_composition}: Matrix (age x sex) of pooled compositions
    \item \code{pooled_age_proportions}: Matrix (age x sex) of pooled proportions
    \item \code{age_cvs}: 3D array of CVs for age compositions
    \item \code{age_proportions_cvs}: 3D array of CVs for age proportions
    \item \code{pooled_age_cv}: Matrix of pooled CVs
    \item \code{pooled_age_proportions_cv}: Matrix of pooled proportion CVs
    \item \code{age_ci_lower}: 3D array of 2.5th percentile values
    \item \code{age_ci_upper}: 3D array of 97.5th percentile values
    \item \code{ages}: Vector of age bins
    \item \code{strata_names}: Vector of stratum names
    \item \code{n_bootstraps}: Number of bootstrap iterations
    \item \code{plus_group_age}: Plus group setting
    \item \code{minus_group_age}: Minus group setting
    \item \code{has_sex_data}: TRUE (sex-specific analysis)
    \item \code{scaling_type}: Type of scaling applied
  }
}
\description{
Calculates scaled age compositions from fish data with cohort model-assigned ages,
  applying the same scaling and bootstrap methodology as length compositions.
  Supports both weight-based scaling (commercial fisheries) and density-based scaling (surveys).
}
\details{
This function applies the same scaling methodology as \code{\link{calculate_length_compositions}}
but operates on age bins instead of length bins. The workflow is:

1. Assign ages to fish using \code{\link{assign_ages_from_cohort}}
2. Bin fish by age (instead of length)
3. Apply weight-based or density-based scaling
4. Perform hierarchical bootstrap resampling for uncertainty estimation

**Scaling approaches:**

*Weight-based (commercial fisheries):*
- Sample scaling: total_catch_weight_kg / observed_sample_weight
- Stratum scaling: stratum_total_catch_kg / sum_of_sample_catches_in_stratum

*Density-based (surveys):*
- Sample scaling: catch_density_kg_km2 * sample_area_km2 / observed_sample_weight
- Stratum scaling: stratum_area_km2 / sum_of_sample_areas_in_stratum

**Bootstrap uncertainty:**
Uses hierarchical resampling at two levels:
- Sample-level: Resample samples within strata (captures spatial variation)
- Fish-level: Resample individual fish within samples (captures within-sample variation)
}
\examples{
\dontrun{
# Step 1: Fit cohort model on aged subsample
aged_data <- data.frame(
  age = c(2, 3, 3, 4, 5),
  length = c(25, 30, 32, 38, 42),
  year = c(2020, 2020, 2021, 2021, 2022),
  sex = c("male", "female", "male", "female", "male")
)
cohort_model <- fit_cohort_alk(aged_data, by_sex = TRUE)

# Step 2: Assign ages to full fish dataset
fish_data_with_ages <- assign_ages_from_cohort(
  fish_data = full_fish_data,
  cohort_model = cohort_model,
  method = "mode"
)

# Step 3: Calculate scaled age compositions
age_comps <- calculate_age_compositions_from_cohort(
  fish_data = fish_data_with_ages,
  strata_data = strata_data,
  age_range = c(1, 10),
  lw_params_male = c(a = 0.01, b = 3.0),
  lw_params_female = c(a = 0.01, b = 3.0),
  lw_params_unsexed = c(a = 0.01, b = 3.0),
  bootstraps = 100
)
}

}
\seealso{
\code{\link{fit_cohort_alk}}, \code{\link{assign_ages_from_cohort}},
  \code{\link{calculate_length_compositions}}
}
