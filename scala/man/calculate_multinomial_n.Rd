% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_multinomial_n.R
\name{calculate_multinomial_n}
\alias{calculate_multinomial_n}
\title{Calculate Multinomial Effective Sample Size}
\usage{
calculate_multinomial_n(
  x,
  cvs = NULL,
  stratum = NULL,
  sex = "total",
  all = FALSE,
  sex_categories = c("male", "female", "unsexed", "total"),
  include_pooled = TRUE,
  remove_outliers = 0.05,
  min_proportion = 1e-04,
  min_cv = 0,
  max_cv = 5,
  trace = FALSE,
  quiet = TRUE
)
}
\arguments{
\item{x}{A length_composition object from calculate_length_compositions(), an age_composition object
from calculate_age_compositions(), or a numeric vector of proportions (requires cvs parameter)}

\item{cvs}{Numeric vector of coefficients of variation, required when x is a numeric vector of proportions.
Must be the same length as x. Ignored when x is a composition object.}

\item{stratum}{Character, name of stratum to analyse. If NULL (default), uses pooled data across all strata. Ignored when all = TRUE}

\item{sex}{Character, sex category to analyse: "male", "female", "unsexed", or "total" (default). Ignored when all = TRUE}

\item{all}{Logical, whether to calculate for all combinations of strata and sex categories (default FALSE)}

\item{sex_categories}{Character vector of sex categories to analyse when all = TRUE. Default: c("male", "female", "unsexed", "total")}

\item{include_pooled}{Logical, whether to include pooled results when all = TRUE (default TRUE)}

\item{remove_outliers}{Numeric, proportion of outliers to remove (0-1). Default 0.05 removes worst 5 percent of fits}

\item{min_proportion}{Numeric, minimum proportion threshold to include in analysis (default 0.0001)}

\item{min_cv}{Numeric, minimum CV threshold to include in analysis (default 0.0)}

\item{max_cv}{Numeric, maximum CV threshold to include in analysis (default 5.0)}

\item{trace}{Logical, whether to show fitting details (default FALSE)}

\item{quiet}{Logical, whether to suppress individual fitting messages when all = TRUE (default TRUE)}
}
\value{
When all = FALSE: Named list containing:
  \itemize{
    \item \code{effective_n}: The estimated multinomial effective sample size
    \item \code{proportions}: Vector of proportions used in the analysis
    \item \code{cvs}: Vector of CVs used in the analysis
    \item \code{n_bins}: Number of length or age bins included in the analysis
    \item \code{fit_summary}: Summary of the nonlinear model fit
  }

  When all_combinations = TRUE: Data frame with columns:
  \itemize{
    \item \code{stratum}: Stratum name ("Pooled" for pooled results)
    \item \code{sex}: Sex category
    \item \code{effective_n}: Estimated effective sample size
    \item \code{n_bins}: Number of length or age bins used
    \item \code{fit_quality}: Model fit quality (residual standard error)
  }
}
\description{
Calculates the multinomial effective sample size from length or age composition proportions and
  their coefficients of variation. Can analyse a single combination or all combinations of strata and sex categories.
}
\details{
The function fits a nonlinear model based on the multinomial distribution relationship:
CV = sqrt(n * P * (1 - P)) / (n * P)

where:
- CV is the coefficient of variation
- P is the proportion
- n is the effective sample size (parameter to be estimated)

Bins with very small proportions or very large CVs are excluded as they
can unduly influence the fit. An optional outlier removal step can be applied
to improve the robustness of the estimate.
}
\examples{
\dontrun{
# For length compositions
test_data <- generate_test_data()
lc_result <- calculate_length_compositions(
  fish_data = test_data$fish_data,
  strata_data = test_data$strata_data,
  length_range = c(20, 40),
  lw_params_male = c(a = 0.01, b = 3.0),
  lw_params_female = c(a = 0.01, b = 3.0),
  lw_params_unsexed = c(a = 0.01, b = 3.0),
  bootstraps = 100
)

# Calculate effective sample size for total (pooled across strata)
eff_n <- calculate_multinomial_n(lc_result, sex = "total")
print(eff_n$effective_n)

# Calculate for specific stratum and sex
eff_n_male_a <- calculate_multinomial_n(lc_result, stratum = "A", sex = "male")

# Calculate for all combinations
all_n <- calculate_multinomial_n(lc_result, all_combinations = TRUE)
print(all_n)

# Calculate only for total sex category, all strata
total_n <- calculate_multinomial_n(lc_result,
  all_combinations = TRUE,
  sex_categories = "total"
)

# For age compositions
age_key <- generate_age_length_key(
  length_range = c(20, 40),
  age_range = c(1, 10),
  growth_model = "von_bertalanffy",
  params = list(L_inf = 35, k = 0.3, t0 = -0.1)
)
ac_result <- calculate_age_compositions(lc_result, age_key)
eff_n_age <- calculate_multinomial_n(ac_result, sex = "total")
all_n_age <- calculate_multinomial_n(ac_result, all_combinations = TRUE)

# From raw vectors of proportions and CVs
props <- c(0.05, 0.15, 0.30, 0.25, 0.15, 0.07, 0.03)
cv_vals <- c(0.8, 0.4, 0.2, 0.25, 0.45, 0.7, 1.1)
eff_n_raw <- calculate_multinomial_n(props, cvs = cv_vals)
print(eff_n_raw$effective_n)
}

}
\references{
Pennington, M. 1996. Estimating the mean and variance from highly skewed marine data.
Fisheries Bulletin 94: 498-505.
}
\seealso{
\code{\link{calculate_length_compositions}} for generating length composition data,
\code{\link{calculate_age_compositions}} for generating age composition data,
\code{\link{get_summary}} for summary statistics including CVs
}
